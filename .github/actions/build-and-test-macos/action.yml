name: Build and test RedisBloom
description: Build and test RedisBloom

runs:
  using: composite
  steps:
    - name: Build Redis
      working-directory: redis
      shell: bash
      run: |
        make install
        echo "REDIS_SERVER=$GITHUB_WORKSPACE/redis/src/redis-server" >> $GITHUB_ENV
        echo "$GITHUB_WORKSPACE/redis/src" >> $GITHUB_PATH
        export PATH="$GITHUB_WORKSPACE/redis/src:$PATH"
        redis-server --version
    - name: Build RedisBloom
      shell: bash
      run: |
        echo ${PATH}
        make --version
        make build
    - name: Install Python dependencies
      shell: bash
      run: |
        python3 -m venv venv
        . venv/bin/activate
        python3 -m pip install --upgrade pip setuptools wheel
        python3 -m pip install -r tests/flow/requirements.txt
        python3 -m pip install -r .install/build_package_requirements.txt
    - name: Run tests
      shell: bash
      run: |
        . venv/bin/activate
        make test
